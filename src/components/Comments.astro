---
interface Props {
	postSlug: string;
}

const { postSlug } = Astro.props;
---

<div class="comments-section">
	<h2>Comments</h2>

	<div id="comments-list" class="comments-list">
		<!-- Comments will be loaded here -->
	</div>

	<form id="comment-form" class="comment-form">
		<h3>Add a Comment</h3>
		<div class="form-group">
			<label for="author">Name *</label>
			<input type="text" id="author" name="author" required />
		</div>
		<div class="form-group">
			<label for="email">Email *</label>
			<input type="email" id="email" name="email" required />
		</div>
		<div class="form-group">
			<label for="content">Comment *</label>
			<textarea id="content" name="content" rows="5" required></textarea>
		</div>
		<button type="submit" class="submit-button">Submit Comment</button>
		<div id="form-message" class="form-message"></div>
	</form>
</div>

<style lang="scss">
	@use '../styles/variables' as *;
	@use '../styles/mixins' as *;

	.comments-section {
		margin-top: ($spacing-xl * 2);
		padding-top: $spacing-xl;
		border-top: 1px solid rgb(var(--gray-light));

		h2 {
			margin-bottom: $spacing-xl;
			color: rgb(var(--gray-dark));
		}

		h3 {
			margin-bottom: $spacing-lg;
			font-size: $font-size-xl;
			color: rgb(var(--gray-dark));
		}
	}

	.comments-list {
		margin-bottom: ($spacing-xl * 2);
		display: flex;
		flex-direction: column;
		gap: $spacing-lg;
	}

	.comment-item {
		padding: $spacing-lg;
		background: white;
		border: 1px solid rgb(var(--gray-light));
		border-radius: $border-radius;
		transition: all $transition-normal;

		&:hover {
			border-color: rgb(var(--gray));
		}

		.comment-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: $spacing-sm;
			flex-wrap: wrap;
			gap: $spacing-sm;

			.comment-author {
				font-weight: 600;
				color: rgb(var(--black));
			}

			.comment-date {
				font-size: $font-size-sm;
				color: rgb(var(--gray));
			}
		}

		.comment-content {
			color: rgb(var(--gray-dark));
			line-height: 1.6;
			white-space: pre-wrap;
		}
	}

	.comment-form {
		padding: $spacing-xl;
		background: white;
		border: 1px solid rgb(var(--gray-light));
		border-radius: $border-radius;

		.form-group {
			margin-bottom: $spacing-lg;

			label {
				display: block;
				margin-bottom: $spacing-xs;
				font-weight: 500;
				color: rgb(var(--gray-dark));
			}

			input,
			textarea {
				width: 100%;
				padding: $spacing-sm;
				border: 1px solid rgb(var(--gray-light));
				border-radius: $border-radius-small;
				font-size: $font-size-base;
				font-family: $font-family;
				transition: all $transition-normal;
				box-sizing: border-box;

				&:focus {
					outline: none;
					border-color: var(--accent);
					box-shadow: 0 0 0 3px rgba(35, 55, 255, 0.1);
				}
			}

			textarea {
				resize: vertical;
				min-height: 120px;
			}
		}

		.submit-button {
			@include tag-style($glass: true);
			padding: $spacing-sm $spacing-xl;
			cursor: pointer;
			border: none;
			font-size: $font-size-base;

			&:hover {
				transform: translateY(-1px);
			}

			&:disabled {
				opacity: 0.6;
				cursor: not-allowed;
				transform: none;
			}
		}

		.form-message {
			margin-top: $spacing-md;
			padding: $spacing-sm;
			border-radius: $border-radius-small;
			font-size: $font-size-sm;
			display: none;

			&.success {
				display: block;
				background: rgba(34, 197, 94, 0.1);
				color: rgb(34, 197, 94);
				border: 1px solid rgba(34, 197, 94, 0.3);
			}

			&.error {
				display: block;
				background: rgba(239, 68, 68, 0.1);
				color: rgb(239, 68, 68);
				border: 1px solid rgba(239, 68, 68, 0.3);
			}
		}
	}

	@include mobile {
		.comment-form {
			padding: $spacing-md;
		}
	}
</style>

<script define:vars={{ postSlug }}>
	const commentsList = document.getElementById('comments-list');
	const commentForm = document.getElementById('comment-form');
	const formMessage = document.getElementById('form-message');

	// Load comments on page load
	async function loadComments() {
		try {
			console.log('Loading comments for:', postSlug);
			const response = await fetch(`/api/comments/${postSlug}`);
			console.log('Response status:', response.status);
			if (!response.ok) {
				const errorData = await response.json().catch(() => ({}));
				console.error('Failed to fetch comments:', errorData);
				throw new Error(errorData.error || 'Failed to fetch comments');
			}
			const comments = await response.json();
			console.log('Loaded comments:', comments.length);

			if (comments.length === 0) {
				commentsList.innerHTML = '<p style="color: rgb(var(--gray)); font-style: italic;">No comments yet. Be the first to comment!</p>';
				return;
			}

			commentsList.innerHTML = comments
				.map(
					(comment) => `
					<div class="comment-item">
						<div class="comment-header">
							<span class="comment-author">${escapeHtml(comment.author)}</span>
							<span class="comment-date">${new Date(comment.createdAt).toLocaleDateString()}</span>
						</div>
						<div class="comment-content">${escapeHtml(comment.content)}</div>
					</div>
				`
				)
				.join('');
		} catch (error) {
			console.error('Error loading comments:', error);
			if (commentsList) {
				commentsList.innerHTML = '<p style="color: rgb(239, 68, 68);">Failed to load comments. Please refresh the page.</p>';
			}
		}
	}

	// Handle form submission
	commentForm?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const submitButton = commentForm?.querySelector('.submit-button');
		if (submitButton) submitButton.disabled = true;
		if (formMessage) {
			formMessage.classList.remove('success', 'error');
			formMessage.style.display = 'none';
		}

		const formData = new FormData(commentForm);
		const data = {
			author: String(formData.get('author') || ''),
			email: String(formData.get('email') || ''),
			content: String(formData.get('content') || ''),
		};

		try {
			const response = await fetch(`/api/comments/${postSlug}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(data),
			});

			const result = await response.json();

			if (!response.ok) {
				throw new Error(result.error || 'Failed to submit comment');
			}

			// Show success message
			if (formMessage) {
				formMessage.textContent = 'Comment submitted successfully!';
				formMessage.classList.add('success');
				formMessage.style.display = 'block';
			}

			// Reset form
			commentForm.reset();

			// Reload comments
			await loadComments();
		} catch (error) {
			console.error('Error submitting comment:', error);
			if (formMessage) {
				formMessage.textContent = error instanceof Error ? error.message : 'Failed to submit comment. Please try again.';
				formMessage.classList.add('error');
				formMessage.style.display = 'block';
			}
		} finally {
			if (submitButton) submitButton.disabled = false;
		}
	});

	function escapeHtml(text) {
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	}

	// Load comments when page loads
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', loadComments);
	} else {
		loadComments();
	}
</script>

